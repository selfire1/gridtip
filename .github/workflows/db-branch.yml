name: Create Database for Branch
on:
  pull_request:

jobs:
  create_database:
    environment: Development
    name: 'Create Database'
    runs-on: ubuntu-latest
    outputs:
      hostname: ${{ steps.create-database.outputs.hostname }}
    steps:
      - name: Create Database
        id: create-database
        uses: tursodatabase/create-database-action@v1
        with:
          organization_name: ${{ secrets.TURSO_ORGANIZATION_NAME }}
          api_token: ${{ secrets.TURSO_API_TOKEN }}
          existing_database_name: ${{ secrets.TURSO_DATABASE_NAME }}

  build_preview:
    needs: create_database
    name: 'Build Preview'
    runs-on: ubuntu-latest
    environment: Development
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup node
        uses: actions/setup-node@v5
        with:
          node-version-file: './.nvmrc'

      - name: Setup bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun ci

      - name: Apply migrations
        env:
          TURSO_DATABASE_URL: libsql://${{ needs.create_database.outputs.hostname }}?authToken=${{ secrets.TURSO_AUTH_TOKEN }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
        run: bun run db:migrate

      - name: Install Vercel CLI
        run: bun install --global vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project Artifacts
        env:
          TURSO_DATABASE_URL: libsql://${{ needs.create_database.outputs.hostname }}?authToken=${{ secrets.TURSO_AUTH_TOKEN }}
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy Project Artifacts to Vercel
        id: deploy
        run: |
          URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "preview_url=$URL" >> $GITHUB_OUTPUT

      - name: Post Preview Link to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ Preview deployed to: ${{ steps.deploy.outputs.preview_url }}`
            })
